# Scripts for the prow job periodic-dind-build

## [Prow job](https://github.com/florencepascual/test-infra/blob/master/config/jobs/periodic/docker-in-docker/periodic-dind-build.yaml)

The prow job is supposed to build the docker-ce and containerd packages for ppc64le and test them. 
We also get the environment variable file containing the versions of docker and containerd we want to build, from our internal COS Bucket and push the packages to the same COS Bucket.

If the prow job clones itself this repo, it will be located at : /home/prow/go/src/github.com/ppc64le-cloud/docker-ce-build

1. [Start the docker daemon](https://github.com/florencepascual/test-infra/blob/e60be4741e286b867a08286ae9515b14bdc96825/config/jobs/periodic/docker-in-docker/periodic-dind-build.yaml#L58)
2. [Access to the internal COS Bucket for the environment variable file and the dockertest repository](https://github.com/florencepascual/test-infra/blob/e60be4741e286b867a08286ae9515b14bdc96825/config/jobs/periodic/docker-in-docker/periodic-dind-build.yaml#L68)
3. [Get the list of distros we want to build](https://github.com/florencepascual/test-infra/blob/e60be4741e286b867a08286ae9515b14bdc96825/config/jobs/periodic/docker-in-docker/periodic-dind-build.yaml#L101)
4. [Build the packages](https://github.com/florencepascual/test-infra/blob/e60be4741e286b867a08286ae9515b14bdc96825/config/jobs/periodic/docker-in-docker/periodic-dind-build.yaml#L138)
5. [Test the packages](https://github.com/florencepascual/test-infra/blob/e60be4741e286b867a08286ae9515b14bdc96825/config/jobs/periodic/docker-in-docker/periodic-dind-build.yaml#L167)
6. [Push to COS Buckets](https://github.com/florencepascual/test-infra/blob/e60be4741e286b867a08286ae9515b14bdc96825/config/jobs/periodic/docker-in-docker/periodic-dind-build.yaml#L183)

## 7 scripts :

- dockerd-waiting.sh
This script checks if the docker daemon has started and is running.

- get_env.sh
This script gets the environment variable file, containing the version of docker and containerd we want to build, and also the dockertest repository we use for the tests.

- build.sh
This script builds the version of docker and containerd we specified in the environment variable file.

- test.sh
This script sets up the tests for the packages. In this script, we run another docker container, in which we run test_launch.sh. It also generates a errors.txt file with a summary of the tests for each distro and the exit codes of each test.

- test_launch.sh
This script is called in a for loop in the test.sh. This launches the tests for every distro we have built.

- check_tests.sh
This script checks in the errors.txt, generated by the test.sh, if there are any errors in the tests of the packages.

- push_COS.sh
This script pushes the packages built, the tests and the log to our internal COS Bucket, it does not push anything to the COS Bucket shared with Docker, since it is still a test.
The goal would be to push to our internal COS bucket, whether there are any errors or not, and to push to the COS Bucket shared with Docker, only if there are no errors.

## [3 images :](https://github.com/florencepascual/test-infra/tree/master/images/docker-in-docker)

- dind-docker-build
This Dockerfile is used for getting a docker-in-docker container. It is used for the basis of the prow job, as well as for the container building the packages and the one testing the packages.

- test-DEBS and test-RPMS
These two Dockerfiles are used in the test part. Depending on the distro type (debs or rpms), we use them to build a container to test the packages and launch test_launch.sh


How to test the scripts manually IN A POD :

0. Set up the pod

You need first to set up the secrets docker-token and secret-s3 with kubectl.

```bash
touch pod.yaml
```
Add the following to the pod.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-docker-build
spec:
  automountServiceAccountToken: false
  containers:
  - name: test
    command:
    - /usr/local/bin/dockerd-entrypoint.sh
    image: quay.io/powercloud/docker-ce-build
    resources: {}
    terminationMessagePolicy: FallbackToLogsOnError
    securityContext:
      privileged: true
    volumeMounts:
    - name: docker-graph-storage
      mountPath: /var/lib/docker
    env:
      - name: DOCKER_SECRET_AUTH
        valueFrom:
          secretKeyRef:
            name: docker-token
            key: .dockerconfigjson
      - name: S3_SECRET_AUTH
        valueFrom:
          secretKeyRef:
            name: secret-s3
            key: password
  restartPolicy: Never
  terminationGracePeriodSeconds: 18
  volumes:
  - name: docker-graph-storage
    emptyDir: {}
status: {}  
```

```
kubectl apply -f pod.yaml
kubectl exec -it pod/pod-docker-build -- /bin/bash
```

1. Get the scripts

```
git clone https://github.com/florencepascual/docker-ce-build.git
cp docker-ce-build/prowjob-periodic-dind-build.sh .
chmod a+x *.sh
rm -rf docker-ce-build
nohup bash -x prowjob-periodic-dind-build.sh &> nohup.out &
```

```
URL_GITHUB="https://github.com/florencepascual/docker-ce-build.git"

# path to the scripts 
PATH_SCRIPTS="/workspace/docker-ce-build"
export PATH_SCRIPTS

# clone the directory where the scripts are
echo "* Git clone *"
git clone ${URL_GITHUB} ${PATH_SCRIPTS}

wget -O ${PATH_SCRIPTS}/dockerd-entrypoint.sh https://raw.githubusercontent.com/docker-library/docker/master/dockerd-entrypoint.sh 

chmod a+x ${PATH_SCRIPTS}/*.sh
```

2. Start the docker daemon
```
echo "** Starting dockerd **"
# Check whether the docker daemon has started
source ${PATH_SCRIPTS}/dockerd-waiting.sh
```

3. Get the environment files and the dockertest
```
echo "*** COS Bucket ***"
${PATH_SCRIPTS}/get_env.sh
set -o allexport
source env.list
source env-distrib.list
```

4. Build docker-ce and containerd
```
echo "*** ** BUILD ** ***"
source ${PATH_SCRIPTS}/build.sh 
```

5. Test the packages
```
echo "*** *** TEST *** ***"
source ${PATH_SCRIPTS}/test.sh
```

6. Check the tests
```
echo "*** *** * TESTS CHECK * *** ***"
source ${PATH_SCRIPTS}/check_tests.sh
cat ${PATH_TEST_ERRORS}
echo ${CHECK_TESTS_BOOL}
```

7.  Push to the COS Bucket (the script will push to the COS Bucket shared with Docker, use it gingerly)
```
echo "*** *** ** COS Bucket ** *** ***"
${PATH_SCRIPTS}/push_COS.sh
```